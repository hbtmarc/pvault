rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    // Admins (por UID). Para seu caso: só você.
    function isAdmin() {
      return signedIn() && request.auth.uid in [
        "JPqv3o4EIqQyfbnWVS2KEcL1hoo1"
      ];
    }

    // Documento "perfil" do usuário: /users/{uid}
    match /users/{userId} {
      // Usuário cria/edita seu próprio perfil
      allow create: if signedIn() && request.auth.uid == userId;
      allow update, delete: if signedIn() && request.auth.uid == userId;

      // Usuário lê o próprio perfil; admin pode ler perfis para listar usuários
      allow read: if (signedIn() && request.auth.uid == userId) || isAdmin();
    }

    // Subcoleções do usuário: /users/{uid}/categories|transactions|budgets|recurringRules|...
    match /users/{userId}/{document=**} {
      // Dono lê tudo dele; admin lê tudo de todos (para personificar)
      allow read: if (signedIn() && request.auth.uid == userId) || isAdmin();

      // Dono pode escrever no próprio espaço.
      // IMPORTANTE: admin NÃO escreve em outros usuários (read-only cross-account).
      allow write: if signedIn() && request.auth.uid == userId;
    }

    // Negar qualquer outra coisa fora de /users/*
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
